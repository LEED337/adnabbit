<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdNabbit - Complete Your Subscription</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="js/stripe-client.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            min-height: 100vh;
        }
        .header {
            background: #1E3A8A;
            color: white;
            padding: 1rem 0;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .payment-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        .order-summary {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        .payment-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .plan-details {
            border: 2px solid #1E3A8A;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: #eff6ff;
        }
        .plan-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 0.5rem;
        }
        .plan-price {
            font-size: 2rem;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 0.5rem;
        }
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }
        .plan-features li {
            padding: 0.25rem 0;
            color: #374151;
        }
        .plan-features li::before {
            content: 'âœ“';
            color: #10b981;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        .user-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .user-info h3 {
            margin: 0 0 0.5rem 0;
            color: #1E3A8A;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }
        #card-element {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
        }
        #card-element.StripeElement--focus {
            border-color: #1E3A8A;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        #card-errors {
            color: #dc2626;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .btn {
            width: 100%;
            padding: 1rem;
            background: #1E3A8A;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover:not(:disabled) {
            background: #1e40af;
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .security-info {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
            color: #6b7280;
            font-size: 0.85rem;
        }
        .security-info::before {
            content: 'ðŸ”’';
            margin-right: 0.5rem;
        }
        .total-row {
            border-top: 2px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
        }
        .total-amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1E3A8A;
        }
        .demo-notice {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }
        @media (max-width: 768px) {
            .payment-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Complete Your AdNabbit Subscription</h1>
    </div>

    <div class="container">
        <div class="demo-notice">
            <strong>Demo Mode:</strong> This is a demonstration of the payment flow. No actual charges will be made.
        </div>

        <div class="payment-container">
            <!-- Order Summary -->
            <div class="order-summary">
                <h2>Order Summary</h2>
                
                <div class="user-info">
                    <h3>Account Information</h3>
                    <div id="userDetails">Loading...</div>
                </div>

                <div class="plan-details" id="planDetails">
                    <!-- Plan details will be populated by JavaScript -->
                </div>

                <div class="total-row">
                    <span class="total-label">Monthly Total:</span>
                    <span class="total-amount" id="totalAmount">$0</span>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="payment-form">
                <h2>Payment Information</h2>
                
                <form id="payment-form">
                    <div class="form-group">
                        <label for="card-element">Credit or Debit Card</label>
                        <div id="card-element">
                            <!-- Stripe Elements will create form elements here -->
                        </div>
                        <div id="card-errors" role="alert"></div>
                    </div>

                    <button type="submit" id="submit-button" class="btn">
                        <span id="button-text">Start Subscription - $<span id="button-amount">0</span>/month</span>
                        <span id="spinner" style="display: none;">Processing...</span>
                    </button>
                </form>

                <div class="security-info">
                    Secured by Stripe. Your payment information is encrypted and secure.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Plan configurations
        const plans = {
            basic: {
                name: 'Basic Plan',
                price: 150,
                screens: 10,
                features: [
                    'Up to 10 digital screens',
                    'Basic analytics dashboard',
                    'Email support',
                    'Campaign scheduling',
                    'Content management'
                ]
            },
            standard: {
                name: 'Standard Plan',
                price: 200,
                screens: 15,
                features: [
                    'Up to 15 digital screens',
                    'Advanced analytics & reports',
                    'Priority support',
                    'A/B testing capabilities',
                    'Custom targeting options',
                    'API access'
                ]
            },
            premium: {
                name: 'Premium Plan',
                price: 300,
                screens: 30,
                features: [
                    'Up to 30 digital screens',
                    'Premium analytics suite',
                    '24/7 phone support',
                    'Advanced targeting & AI',
                    'Custom integrations',
                    'Dedicated account manager'
                ]
            }
        };

        // Get user data from URL parameters or localStorage
        function getUserData() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const plan = urlParams.get('plan');
            
            if (email && plan) {
                return {
                    email: email,
                    plan: plan,
                    firstName: urlParams.get('firstName') || 'User',
                    lastName: urlParams.get('lastName') || '',
                    company: urlParams.get('company') || 'Company'
                };
            }
            
            // Fallback to localStorage
            const users = JSON.parse(localStorage.getItem('adnabbit_users') || '[]');
            return users[users.length - 1] || {
                email: 'demo@example.com',
                plan: 'basic',
                firstName: 'Demo',
                lastName: 'User',
                company: 'Demo Company'
            };
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const userData = getUserData();
            const selectedPlan = plans[userData.plan] || plans.basic;

            // Update user details
            document.getElementById('userDetails').innerHTML = `
                <strong>${userData.firstName} ${userData.lastName}</strong><br>
                ${userData.email}<br>
                ${userData.company}
            `;

            // Update plan details
            document.getElementById('planDetails').innerHTML = `
                <div class="plan-name">${selectedPlan.name}</div>
                <div class="plan-price">$${selectedPlan.price}/month</div>
                <ul class="plan-features">
                    ${selectedPlan.features.map(feature => `<li>${feature}</li>`).join('')}
                </ul>
            `;

            // Update totals
            document.getElementById('totalAmount').textContent = `$${selectedPlan.price}`;
            document.getElementById('button-amount').textContent = selectedPlan.price;

            // Initialize Stripe (Demo mode - replace with your publishable key)
            initializeStripe(selectedPlan.price);
        });

        function initializeStripe(amount) {
            // Initialize Stripe client service
            const stripeClient = new StripeClient();
            const cardElement = stripeClient.initializeElements('card-element');

            // Handle form submission
            const form = document.getElementById('payment-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const submitButton = document.getElementById('submit-button');
                const buttonText = document.getElementById('button-text');
                const spinner = document.getElementById('spinner');
                
                // Disable form and show loading
                submitButton.disabled = true;
                buttonText.style.display = 'none';
                spinner.style.display = 'inline';

                try {
                    const userData = getUserData();
                    
                    // Create payment method
                    const paymentMethod = await stripeClient.createPaymentMethod({
                        name: `${userData.firstName} ${userData.lastName}`,
                        email: userData.email,
                    });

                    // Create subscription on backend
                    const subscriptionResult = await stripeClient.createSubscription({
                        paymentMethodId: paymentMethod.id,
                        customerEmail: userData.email,
                        customerName: `${userData.firstName} ${userData.lastName}`,
                        plan: userData.plan
                    });
                    
                    // Store subscription info
                    localStorage.setItem('adnabbit_subscription', JSON.stringify({
                        subscriptionId: subscriptionResult.subscriptionId,
                        customerId: subscriptionResult.customerId,
                        status: 'active',
                        plan: userData.plan,
                        amount: amount,
                        createdAt: new Date().toISOString()
                    }));

                    // Success - redirect to dashboard
                    alert('ðŸŽ‰ Subscription created successfully! Welcome to AdNabbit!');
                    window.location.href = 'dashboard.html?role=Subscriber';

                } catch (error) {
                    console.error('Payment error:', error);
                    document.getElementById('card-errors').textContent = error.message;
                    
                    // Re-enable form
                    submitButton.disabled = false;
                    buttonText.style.display = 'inline';
                    spinner.style.display = 'none';
                }
            });

            // Handle real-time validation errors from the card Element
            stripeClient.onCardChange(({error}) => {
                const displayError = document.getElementById('card-errors');
                if (error) {
                    displayError.textContent = error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }

        // Create subscription via backend API
        async function createSubscription(paymentMethodId, amount) {
            try {
                const userData = getUserData();
                
                // In a real implementation, this would call your backend API
                // For now, we'll simulate the backend response
                const response = await simulateBackendCall({
                    paymentMethodId: paymentMethodId,
                    customerEmail: userData.email,
                    customerName: `${userData.firstName} ${userData.lastName}`,
                    plan: userData.plan,
                    amount: amount
                });

                return response;
            } catch (error) {
                console.error('Backend error:', error);
                return { success: false, error: error.message };
            }
        }

        // Simulate backend API call (replace with actual backend integration)
        async function simulateBackendCall(data) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Simulate successful subscription creation
            return {
                success: true,
                subscriptionId: 'sub_' + Math.random().toString(36).substr(2, 9),
                customerId: 'cus_' + Math.random().toString(36).substr(2, 9),
                status: 'active'
            };
        }
    </script>
</body>
</html>