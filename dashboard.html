<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdNabbit Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        .header {
            background: #1E3A8A;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .logo-icon {
            margin-right: 10px;
            font-size: 1.8rem;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .logout-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 20px;
        }
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6b7280;
            transition: all 0.3s;
        }
        .tab.active {
            background: #1E3A8A;
            color: white;
        }
        .tab:hover:not(.active) {
            background: #f3f4f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #1E3A8A;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .stat-card p {
            color: #6b7280;
            font-size: 0.9rem;
        }
        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .location-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .location-card:hover {
            transform: translateY(-2px);
        }
        .location-image {
            height: 150px;
            background: linear-gradient(45deg, #1E3A8A, #3B82F6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
        }
        .location-info {
            padding: 1rem;
        }
        .location-info h3 {
            color: #1E3A8A;
            margin-bottom: 0.5rem;
        }
        .location-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-available {
            background: #dcfce7;
            color: #166534;
        }
        .status-busy {
            background: #fef3c7;
            color: #92400e;
        }
        .campaign-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .campaign-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .campaign-title {
            color: #1E3A8A;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .campaign-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .status-active {
            background: #dcfce7;
            color: #166534;
        }
        .status-paused {
            background: #fef3c7;
            color: #92400e;
        }
        .btn {
            background: #1E3A8A;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #1e40af;
        }
        .btn-secondary {
            background: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .pricing-card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }
        .pricing-card.featured {
            border: 2px solid #1E3A8A;
        }
        .pricing-card.featured::before {
            content: 'Most Popular';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #1E3A8A;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1E3A8A;
            margin-bottom: 0.5rem;
        }
        .admin-section {
            display: none;
        }
        .admin-section.show {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            position: relative;
        }
        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        /* Map View Styles */
        #screenMap {
            z-index: 1;
        }
        
        /* Custom Leaflet Marker Styles */
        .custom-marker {
            background: transparent !important;
            border: none !important;
        }
        
        .custom-screen-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 3px solid;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: -20px 0 0 -20px;
        }
        
        .custom-screen-marker:hover {
            transform: scale(1.1);
            z-index: 1000;
        }
        
        .marker-available {
            border-color: #10b981;
            color: #10b981;
        }
        
        .marker-selected {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }
        
        .marker-limited {
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .marker-full {
            border-color: #ef4444;
            color: #ef4444;
        }
        
        /* Screen icon marker styles */
        .screen-icon-marker {
            background: transparent !important;
            border: none !important;
            text-align: center;
            font-size: 16px;
            pointer-events: none;
        }
        
        /* Custom Popup Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        .screen-popup {
            text-align: center;
            min-width: 200px;
        }
        
        .screen-popup .screen-name {
            font-weight: 600;
            color: #1E3A8A;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .screen-popup .screen-details {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .screen-popup .screen-capacity {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .screen-popup .screen-price {
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 1rem;
        }
        
        .screen-popup .popup-button {
            background: #1E3A8A;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            margin: 0 0.25rem;
        }
        
        .screen-popup .popup-button:hover {
            background: #1e40af;
        }
        
        .screen-popup .popup-button.secondary {
            background: #6b7280;
        }
        
        .screen-popup .popup-button.secondary:hover {
            background: #4b5563;
        }
        .selected-location-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }
        .selected-location-item h4 {
            color: #1E3A8A;
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }
        .selected-location-item p {
            color: #6b7280;
            margin: 0;
            font-size: 0.9rem;
        }
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            #screenMap {
                height: 400px;
            }
            .screen-marker {
                transform: scale(0.8);
            }
            .screen-marker:hover {
                transform: scale(0.9);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">📺</span>
                AdNabbit
            </div>
            <div class="user-info">
                <span id="userRole">Subscriber</span>
                <a href="flutter_app.html" class="logout-btn">Logout</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="tab" onclick="showTab('ads')">🎨 My Ads</button>
            <button class="tab" onclick="showTab('locations')">📍 Select Locations</button>
            <button class="tab" onclick="showTab('subscription')">💳 Subscription</button>
            <button class="tab admin-section" id="adminTab" onclick="showTab('admin')">⚙️ Admin Panel</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: #1E3A8A; margin-bottom: 1rem;">Welcome to AdNabbit!</h2>
                <p style="color: #6b7280;">Manage your digital advertising campaigns across premium screen locations.</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="activeAds">3</h3>
                    <p>Active Ads</p>
                </div>
                <div class="stat-card">
                    <h3 id="selectedLocations">8</h3>
                    <p>Screen Locations</p>
                </div>
                <div class="stat-card">
                    <h3 id="monthlyViews">12.4K</h3>
                    <p>Monthly Views</p>
                </div>
                <div class="stat-card">
                    <h3 id="currentPlan">Standard</h3>
                    <p>Current Plan</p>
                </div>
            </div>

            <div class="campaign-card">
                <div class="campaign-header">
                    <div class="campaign-title">Quick Actions</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <button class="btn" onclick="showTab('ads')">📤 Upload New Ad</button>
                    <button class="btn" onclick="showTab('locations')">📍 Choose Locations</button>
                    <button class="btn" onclick="showTab('subscription')">💳 Manage Plan</button>
                    <button class="btn btn-secondary" onclick="viewAnalytics()">📊 View Analytics</button>
                </div>
            </div>

            <div class="campaign-card">
                <div class="campaign-header">
                    <div class="campaign-title">Recent Activity</div>
                </div>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                        ✅ Ad "Summer Sale 2024" approved and live on 8 screens
                    </li>
                    <li style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                        📍 Added 3 new locations: Coffee shops downtown
                    </li>
                    <li style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                        💳 Payment processed successfully for January
                    </li>
                    <li style="padding: 0.5rem 0;">
                        📊 Your ads reached 12,400 viewers this month
                    </li>
                </ul>
            </div>
        </div>

        <!-- Locations Tab -->
        <div id="locations" class="tab-content">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: #1E3A8A; margin-bottom: 1rem;">Choose Your Screen Locations</h2>
                <p style="color: #6b7280;">Select premium locations where you want your ads displayed. We handle all the technical setup.</p>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn" id="mapViewBtn" onclick="showMapView()">🗺️ Map View</button>
                    <button class="btn btn-secondary" id="listViewBtn" onclick="showListView()">📋 List View</button>
                </div>
            </div>

            <!-- Map View -->
            <div id="mapView" style="display: none;">
                <div style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #1E3A8A; margin: 0;">Screen Network Map</h3>
                        <div style="display: flex; gap: 1rem; font-size: 0.9rem;">
                            <span>🟢 Available</span>
                            <span>🔵 Selected</span>
                            <span>🟡 Limited</span>
                            <span>🔴 Full</span>
                        </div>
                    </div>
                    
                    <!-- Interactive Map Container -->
                    <div id="screenMap" style="height: 500px; border-radius: 8px; overflow: hidden; border: 2px solid #e5e7eb;"></div>
                </div>
                
                <!-- Selected Locations Summary -->
                <div class="campaign-card">
                    <div class="campaign-header">
                        <div class="campaign-title">Your Selected Locations</div>
                    </div>
                    <div id="selectedLocationsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <p style="color: #1E3A8A; font-weight: 600; margin-bottom: 1rem;">Total: 8 screens • Monthly cost: $285</p>
                        <button class="btn" onclick="saveLocationSelection()">💾 Save Changes</button>
                    </div>
                </div>
            </div>

            <!-- List View (existing) -->
            <div id="listView">
                <div class="locations-grid">
                    <div class="location-card">
                        <div class="location-image">🏢</div>
                        <div class="location-info">
                            <h3>City Creek Center</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Downtown shopping • 12,000 daily visitors</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$45/month per screen</strong> • Capacity: 18/30</p>
                            <span class="location-status status-active">✅ Selected</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="toggleLocation('downtown-mall')">Remove</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="location-card">
                        <div class="location-image">🚇</div>
                        <div class="location-info">
                            <h3>TRAX Station</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Light rail hub • 6,000 daily commuters</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$35/month per screen</strong> • Capacity: 12/30</p>
                            <span class="location-status status-available">Available</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn" onclick="toggleLocation('metro-station')">Add Location</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="location-card">
                        <div class="location-image">🏪</div>
                        <div class="location-info">
                            <h3>Coffee Shop Chain</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">5 locations • Business professionals</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$25/month per location</strong> • Capacity: 22/30</p>
                            <span class="location-status status-active">✅ Selected</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="toggleLocation('coffee-shops')">Remove</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="location-card">
                        <div class="location-image">🏥</div>
                        <div class="location-info">
                            <h3>University Hospital</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Medical campus • Extended viewing time</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$30/month per screen</strong> • Capacity: 8/30</p>
                            <span class="location-status status-available">Available</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn" onclick="toggleLocation('medical-center')">Add Location</button>
                            </div>
                        </div>
                    </div>

                    <div class="location-card">
                        <div class="location-image">🏫</div>
                        <div class="location-info">
                            <h3>University of Utah</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Student union • Young demographic</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$20/month per screen</strong> • Capacity: 15/30</p>
                            <span class="location-status status-active">✅ Selected</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="toggleLocation('university')">Remove</button>
                            </div>
                        </div>
                    </div>

                    <div class="location-card">
                        <div class="location-image">🏬</div>
                        <div class="location-info">
                            <h3>Fashion Place Mall</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Food court • Family shoppers</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$40/month per screen</strong> • Capacity: 25/30</p>
                            <span class="location-status status-active">✅ Selected</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="toggleLocation('shopping-center')">Remove</button>
                            </div>
                        </div>
                    </div>

                    <div class="location-card">
                        <div class="location-image">✈️</div>
                        <div class="location-info">
                            <h3>Salt Lake Airport</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Terminal gates • International travelers</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$60/month per screen</strong> • Capacity: 28/30</p>
                            <span class="location-status status-busy">Limited</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn" onclick="toggleLocation('airport')">Add Location</button>
                            </div>
                        </div>
                    </div>

                    <div class="location-card">
                        <div class="location-image">🏟️</div>
                        <div class="location-info">
                            <h3>Rice-Eccles Stadium</h3>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Event venue • Sports fans</p>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;"><strong>$80/month per screen</strong> • Capacity: 30/30</p>
                            <span class="location-status status-busy">Full - Waitlist</span>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="toggleLocation('stadium')">Join Waitlist</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="campaign-card" style="margin-top: 2rem;">
                    <div class="campaign-header">
                        <div class="campaign-title">Current Selection Summary</div>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 1rem;">You have selected 4 screen locations.</p>
                    <p style="color: #1E3A8A; font-weight: 600; margin-bottom: 1rem;">Monthly cost: $130 (included in your Standard plan)</p>
                    <button class="btn" onclick="saveLocationSelection()">💾 Save Changes</button>
                </div>
            </div>
        </div>

        <!-- My Ads Tab -->
        <div id="ads" class="tab-content">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: #1E3A8A; margin-bottom: 1rem;">My Advertising Content</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Upload your ads and we'll handle getting them displayed on premium screens.</p>
                <button class="btn" onclick="showModal('uploadModal')">📤 Upload New Ad</button>
            </div>
            
            <div class="locations-grid">
                <div class="campaign-card">
                    <div class="campaign-header">
                        <div class="campaign-title">Summer Sale Banner</div>
                        <span class="campaign-status status-active">Live</span>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 1rem;">1920x1080 • Uploaded: Dec 15, 2024 • 8 locations</p>
                    <p style="color: #6b7280; margin-bottom: 1rem;">Views this month: 3,247</p>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="viewAdAnalytics('summer-sale')">📊 View Stats</button>
                        <button class="btn btn-secondary" onclick="pauseAd('summer-sale')">⏸️ Pause</button>
                    </div>
                </div>
                
                <div class="campaign-card">
                    <div class="campaign-header">
                        <div class="campaign-title">Product Launch Video</div>
                        <span class="campaign-status status-active">Live</span>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 1rem;">MP4 • 30 seconds • Uploaded: Dec 10, 2024 • 5 locations</p>
                    <p style="color: #6b7280; margin-bottom: 1rem;">Views this month: 1,892</p>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="viewAdAnalytics('product-launch')">📊 View Stats</button>
                        <button class="btn btn-secondary" onclick="pauseAd('product-launch')">⏸️ Pause</button>
                    </div>
                </div>

                <div class="campaign-card">
                    <div class="campaign-header">
                        <div class="campaign-title">Holiday Special</div>
                        <span class="campaign-status status-paused">Under Review</span>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 1rem;">1920x1080 • Uploaded: Dec 20, 2024</p>
                    <p style="color: #6b7280; margin-bottom: 1rem;">Status: Being reviewed by our team (typically 24-48 hours)</p>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" disabled>⏳ Pending Review</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Tab -->
        <div id="subscription" class="tab-content">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: #1E3A8A; margin-bottom: 1rem;">Subscription Management</h2>
                <p style="color: #6b7280;">Manage your AdNabbit subscription and billing.</p>
            </div>

            <div class="campaign-card">
                <div class="campaign-header">
                    <div class="campaign-title">Current Plan: Standard</div>
                    <span class="campaign-status status-active">Active</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <strong>Monthly Cost:</strong> $200<br>
                        <strong>Screen Limit:</strong> 15 screens<br>
                        <strong>Currently Using:</strong> 8 screens
                    </div>
                    <div>
                        <strong>Next Billing:</strong> Jan 15, 2025<br>
                        <strong>Payment Method:</strong> •••• 4242<br>
                        <strong>Status:</strong> <span style="color: #166534;">Paid</span>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn" onclick="showModal('upgradeModal')">⬆️ Upgrade Plan</button>
                    <button class="btn btn-secondary" onclick="updatePayment()">💳 Update Payment</button>
                </div>
            </div>
            
            <div class="pricing-grid">
                <div class="pricing-card">
                    <h3>Basic Plan</h3>
                    <div class="price">$150</div>
                    <p>per month</p>
                    <ul style="text-align: left; margin: 1rem 0; color: #6b7280;">
                        <li>Up to 10 screens</li>
                        <li>Basic analytics</li>
                        <li>Email support</li>
                        <li>Standard locations</li>
                    </ul>
                    <button class="btn btn-secondary" disabled>Current Plan Below</button>
                </div>
                
                <div class="pricing-card featured">
                    <h3>Standard Plan</h3>
                    <div class="price">$200</div>
                    <p>per month</p>
                    <ul style="text-align: left; margin: 1rem 0; color: #6b7280;">
                        <li>Up to 15 screens</li>
                        <li>Advanced analytics</li>
                        <li>Priority support</li>
                        <li>Premium locations</li>
                    </ul>
                    <button class="btn" style="background: #166534;" disabled>✅ Current Plan</button>
                </div>
                
                <div class="pricing-card">
                    <h3>Premium Plan</h3>
                    <div class="price">$300</div>
                    <p>per month</p>
                    <ul style="text-align: left; margin: 1rem 0; color: #6b7280;">
                        <li>Up to 30 screens</li>
                        <li>Real-time analytics</li>
                        <li>Phone support</li>
                        <li>All locations + custom</li>
                    </ul>
                    <button class="btn" onclick="upgradeToPremium()">⬆️ Upgrade</button>
                </div>
            </div>

            <div class="campaign-card">
                <div class="campaign-header">
                    <div class="campaign-title">Billing History</div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <th style="text-align: left; padding: 0.5rem; color: #1E3A8A;">Date</th>
                                <th style="text-align: left; padding: 0.5rem; color: #1E3A8A;">Plan</th>
                                <th style="text-align: left; padding: 0.5rem; color: #1E3A8A;">Amount</th>
                                <th style="text-align: left; padding: 0.5rem; color: #1E3A8A;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.5rem;">Dec 15, 2024</td>
                                <td style="padding: 0.5rem;">Standard</td>
                                <td style="padding: 0.5rem;">$200.00</td>
                                <td style="padding: 0.5rem; color: #166534;">Paid</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.5rem;">Nov 15, 2024</td>
                                <td style="padding: 0.5rem;">Standard</td>
                                <td style="padding: 0.5rem;">$200.00</td>
                                <td style="padding: 0.5rem; color: #166534;">Paid</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem;">Oct 15, 2024</td>
                                <td style="padding: 0.5rem;">Basic</td>
                                <td style="padding: 0.5rem;">$150.00</td>
                                <td style="padding: 0.5rem; color: #166534;">Paid</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin" class="tab-content admin-section">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: #1E3A8A; margin-bottom: 1rem;">Admin Panel</h2>
                <p style="color: #6b7280;">Manage subscribers, OptiSigns integration, and system settings.</p>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <a href="api-setup.html" class="btn">⚙️ OptiSigns Setup</a>
                    <button class="btn btn-secondary" onclick="refreshScreenData()">🔄 Sync Screens</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>127</h3>
                    <p>Total Subscribers</p>
                </div>
                <div class="stat-card">
                    <h3>89</h3>
                    <p>Active Campaigns</p>
                </div>
                <div class="stat-card">
                    <h3>$12,450</h3>
                    <p>Monthly Revenue</p>
                </div>
                <div class="stat-card">
                    <h3>156</h3>
                    <p>OptiSigns Screens</p>
                </div>
            </div>

            <div class="campaign-card">
                <div class="campaign-header">
                    <div class="campaign-title">Recent Subscriber Activity</div>
                </div>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                        👤 New subscriber: John's Coffee Shop (Standard Plan)
                    </li>
                    <li style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                        📤 Ad uploaded: "Holiday Sale" by TechCorp (pending review)
                    </li>
                    <li style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                        ⬆️ Plan upgrade: Local Gym upgraded to Premium
                    </li>
                    <li style="padding: 0.5rem 0;">
                        🔄 OptiSigns sync: 3 new screens added to network
                    </li>
                </ul>
            </div>

            <div class="campaign-card">
                <div class="campaign-header">
                    <div class="campaign-title">Pending Ad Reviews</div>
                </div>
                <div style="display: grid; gap: 1rem;">
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Holiday Special</strong> - Local Restaurant<br>
                            <small style="color: #6b7280;">Uploaded 2 hours ago • 1920x1080 image</small>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="approveAd('holiday-special')">✅ Approve</button>
                            <button class="btn btn-secondary" onclick="rejectAd('holiday-special')">❌ Reject</button>
                        </div>
                    </div>
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>New Year Sale</strong> - Fashion Store<br>
                            <small style="color: #6b7280;">Uploaded 5 hours ago • 30-second video</small>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="approveAd('new-year-sale')">✅ Approve</button>
                            <button class="btn btn-secondary" onclick="rejectAd('new-year-sale')">❌ Reject</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pricing-grid">
                <div class="pricing-card">
                    <h3>Basic Plan</h3>
                    <div class="price">34</div>
                    <p>subscribers</p>
                    <p style="margin: 1rem 0;">$150/month each</p>
                    <p style="color: #6b7280;">$5,100 monthly revenue</p>
                </div>
                
                <div class="pricing-card featured">
                    <h3>Standard Plan</h3>
                    <div class="price">42</div>
                    <p>subscribers</p>
                    <p style="margin: 1rem 0;">$200/month each</p>
                    <p style="color: #6b7280;">$8,400 monthly revenue</p>
                </div>
                
                <div class="pricing-card">
                    <h3>Premium Plan</h3>
                    <div class="price">13</div>
                    <p>subscribers</p>
                    <p style="margin: 1rem 0;">$300/month each</p>
                    <p style="color: #6b7280;">$3,900 monthly revenue</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideModal('uploadModal')">&times;</span>
            <h2 style="color: #1E3A8A; margin-bottom: 1rem;">Upload New Ad</h2>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">Upload your ad and we'll handle getting it displayed on your selected screens. All ads are reviewed within 24-48 hours.</p>
            <form id="uploadForm">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Ad Title *</label>
                    <input type="text" id="adTitle" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="e.g., Summer Sale 2024" required>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Upload File *</label>
                    <input type="file" id="adFile" accept="image/*,video/*" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;" required>
                    <small style="color: #6b7280;">Supported: JPG, PNG, MP4 • Max size: 50MB • Recommended: 1920x1080</small>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description (Optional)</label>
                    <textarea id="adDescription" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; height: 80px;" placeholder="Brief description of your ad content"></textarea>
                </div>
                <div style="background: #eff6ff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                    <p style="color: #1E3A8A; font-size: 0.9rem; margin: 0;">
                        📍 This ad will be displayed on your 8 selected screen locations once approved.
                    </p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn" onclick="uploadNewAd()">📤 Upload Ad</button>
                    <button type="button" class="btn btn-secondary" onclick="hideModal('uploadModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideModal('upgradeModal')">&times;</span>
            <h2 style="color: #1E3A8A; margin-bottom: 1rem;">Upgrade Your Plan</h2>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">Get access to more screens and premium locations.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="border: 2px solid #e5e7eb; padding: 1rem; border-radius: 6px;">
                    <h3 style="color: #1E3A8A;">Current: Standard</h3>
                    <p style="font-size: 1.5rem; font-weight: bold; color: #1E3A8A;">$200/month</p>
                    <ul style="color: #6b7280; font-size: 0.9rem;">
                        <li>15 screens max</li>
                        <li>Advanced analytics</li>
                        <li>Priority support</li>
                    </ul>
                </div>
                <div style="border: 2px solid #1E3A8A; padding: 1rem; border-radius: 6px;">
                    <h3 style="color: #1E3A8A;">Upgrade to: Premium</h3>
                    <p style="font-size: 1.5rem; font-weight: bold; color: #1E3A8A;">$300/month</p>
                    <ul style="color: #6b7280; font-size: 0.9rem;">
                        <li>30 screens max</li>
                        <li>Real-time analytics</li>
                        <li>Phone support</li>
                        <li>Custom locations</li>
                    </ul>
                </div>
            </div>
            
            <div style="background: #eff6ff; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                <p style="color: #1E3A8A; font-size: 0.9rem; margin: 0;">
                    💡 Upgrade now and get prorated billing. You'll only pay the difference for the remaining days in your current billing cycle.
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn" onclick="processUpgrade()">⬆️ Upgrade to Premium</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('upgradeModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Get user role from URL parameters or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const userRole = urlParams.get('role') || localStorage.getItem('userRole') || 'Subscriber';
        
        document.getElementById('userRole').textContent = userRole;
        
        // Show admin tab only for administrators
        if (userRole === 'Administrator') {
            document.getElementById('adminTab').classList.add('show');
            document.querySelector('.admin-section').classList.add('show');
        }

        // Update dashboard content based on user role
        if (userRole === 'Subscriber') {
            // Hide API setup link for subscribers
            const apiSetupLink = document.querySelector('a[href="api-setup.html"]');
            if (apiSetupLink) {
                apiSetupLink.style.display = 'none';
            }
        }

        // Map and location management
        let map = null;
        let markers = {};
        
        const locationData = {
            'downtown-mall': { 
                name: 'City Creek Center', 
                cost: 45, 
                selected: true, 
                capacity: { used: 18, total: 30 },
                description: 'Downtown shopping • 12,000 daily visitors',
                coordinates: [40.7701, -111.8910] // Salt Lake City coordinates
            },
            'metro-station': { 
                name: 'TRAX Station', 
                cost: 35, 
                selected: false, 
                capacity: { used: 12, total: 30 },
                description: 'Light rail hub • 6,000 daily commuters',
                coordinates: [40.7608, -111.8910]
            },
            'coffee-shops': { 
                name: 'Coffee Shop Chain', 
                cost: 25, 
                selected: true, 
                capacity: { used: 22, total: 30 },
                description: '8 locations • Business professionals',
                coordinates: [40.7505, -111.8804]
            },
            'medical-center': { 
                name: 'University Hospital', 
                cost: 30, 
                selected: false, 
                capacity: { used: 8, total: 30 },
                description: 'Medical campus • Extended viewing time',
                coordinates: [40.7738, -111.8389]
            },
            'university': { 
                name: 'University of Utah', 
                cost: 20, 
                selected: true, 
                capacity: { used: 15, total: 30 },
                description: 'Student union • Young demographic',
                coordinates: [40.7649, -111.8421]
            },
            'shopping-center': { 
                name: 'Fashion Place Mall', 
                cost: 40, 
                selected: true, 
                capacity: { used: 25, total: 30 },
                description: 'Food court • Family shoppers',
                coordinates: [40.6501, -111.9048]
            },
            'airport': { 
                name: 'Salt Lake Airport', 
                cost: 60, 
                selected: false, 
                capacity: { used: 28, total: 30 },
                description: 'Terminal gates • International travelers',
                coordinates: [40.7899, -111.9791]
            },
            'stadium': { 
                name: 'Rice-Eccles Stadium', 
                cost: 80, 
                selected: false, 
                capacity: { used: 30, total: 30 },
                description: 'Event venue • Sports fans (waitlist only)',
                coordinates: [40.7581, -111.8530]
            }
        };

        function showMapView() {
            document.getElementById('mapView').style.display = 'block';
            document.getElementById('listView').style.display = 'none';
            document.getElementById('mapViewBtn').className = 'btn';
            document.getElementById('listViewBtn').className = 'btn btn-secondary';
            updateSelectedLocationsList();
            
            // Initialize map if not already created
            if (!map) {
                // Small delay to ensure the container is visible
                setTimeout(() => {
                    initializeLeafletMap();
                }, 100);
            } else {
                // Invalidate size to fix display issues
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }

        function showListView() {
            document.getElementById('mapView').style.display = 'none';
            document.getElementById('listView').style.display = 'block';
            document.getElementById('mapViewBtn').className = 'btn btn-secondary';
            document.getElementById('listViewBtn').className = 'btn';
        }

        function initializeLeafletMap() {
            console.log('Initializing Leaflet map...');
            
            // Initialize the map centered on Salt Lake City
            map = L.map('screenMap').setView([40.7608, -111.8910], 11);
            
            // Add Stadia Stamen Terrain tiles using the exact format from Leaflet docs
            L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}{r}.{ext}', {
                minZoom: 0,
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://www.stamen.com/" target="_blank">Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            }).addTo(map);
            
            console.log('Map tiles loaded, adding markers...');
            
            // Wait for map to fully load before adding markers
            map.whenReady(function() {
                console.log('Map is ready, adding markers...');
                
                // Add markers for each location
                Object.entries(locationData).forEach(([locationId, location]) => {
                    console.log(`Adding marker for ${locationId}:`, location);
                    addMarkerToMap(locationId, location);
                });
                
                console.log('All markers added to map');
            });
        }
        
        function addMarkerToMap(locationId, location) {
            const statusClass = getMarkerStatusClass(location);
            const color = getMarkerColor(location);
            
            console.log(`Creating marker for ${locationId} with status ${statusClass} and color ${color}`);
            
            // Create a simple circle marker instead of custom HTML
            const marker = L.circleMarker(location.coordinates, {
                radius: 15,
                fillColor: color,
                color: '#ffffff',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            // Add screen icon in the center
            const iconMarker = L.marker(location.coordinates, {
                icon: L.divIcon({
                    html: '📺',
                    className: 'screen-icon-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            // Create popup content
            const popupContent = createPopupContent(locationId, location);
            
            // Bind popup to both markers
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                offset: [0, -10]
            });
            
            iconMarker.bindPopup(popupContent, {
                maxWidth: 300,
                offset: [0, -10]
            });
            
            // Store marker references
            markers[locationId] = { circle: marker, icon: iconMarker };
            
            console.log(`Marker created and added for ${locationId}`);
        }
        
        function getMarkerColor(location) {
            if (location.selected) return '#3b82f6'; // Blue for selected
            if (location.capacity.used >= location.capacity.total) return '#ef4444'; // Red for full
            if (location.capacity.used / location.capacity.total >= 0.9) return '#f59e0b'; // Yellow for limited
            return '#10b981'; // Green for available
        }
        
        function getMarkerStatusClass(location) {
            if (location.selected) return 'marker-selected';
            if (location.capacity.used >= location.capacity.total) return 'marker-full';
            if (location.capacity.used / location.capacity.total >= 0.9) return 'marker-limited';
            return 'marker-available';
        }
        
        function createPopupContent(locationId, location) {
            const isSelected = location.selected;
            const capacityStatus = getCapacityStatus(location.capacity);
            const canSelect = !isSelected && location.capacity.used < location.capacity.total;
            
            const buttonText = isSelected ? 'Remove Location' : 
                              canSelect ? 'Add Location' : 'Join Waitlist';
            const buttonClass = isSelected ? 'secondary' : '';
            
            return `
                <div class="screen-popup">
                    <div class="screen-name">${location.name}</div>
                    <div class="screen-details">${location.description}</div>
                    <div class="screen-capacity">Capacity: ${location.capacity.used}/${location.capacity.total} ads</div>
                    <div class="screen-capacity">Status: ${capacityStatus}</div>
                    <div class="screen-price">$${location.cost}/month</div>
                    <button class="popup-button ${buttonClass}" onclick="toggleLocationFromMap('${locationId}')">
                        ${buttonText}
                    </button>
                </div>
            `;
        }
        
        function toggleLocationFromMap(locationId) {
            toggleLocation(locationId);
            
            // Update marker appearance
            const location = locationData[locationId];
            const markerGroup = markers[locationId];
            if (markerGroup && markerGroup.circle) {
                const newColor = getMarkerColor(location);
                markerGroup.circle.setStyle({
                    fillColor: newColor
                });
                
                // Update popup content for both markers
                const popupContent = createPopupContent(locationId, location);
                markerGroup.circle.setPopupContent(popupContent);
                if (markerGroup.icon) {
                    markerGroup.icon.setPopupContent(popupContent);
                }
            }
        }

        function showLocationDetails(locationId, location) {
            const isSelected = location.selected;
            const capacityStatus = getCapacityStatus(location.capacity);
            const canSelect = !isSelected && location.capacity.used < location.capacity.total;
            
            const message = `📍 ${location.name}\n\n` +
                `${location.description}\n` +
                `💰 Cost: $${location.cost}/month\n` +
                `📊 Capacity: ${location.capacity.used}/${location.capacity.total} ads\n` +
                `🎯 Status: ${capacityStatus}\n\n` +
                `${isSelected ? 'Currently selected for your ads.' : canSelect ? 'Available for selection.' : 'No slots available.'}`;
            
            if (confirm(message + '\n\nWould you like to ' + (isSelected ? 'remove this location?' : canSelect ? 'add this location?' : 'join the waitlist?'))) {
                if (isSelected) {
                    toggleLocation(locationId);
                } else if (canSelect) {
                    toggleLocation(locationId);
                } else {
                    alert('✅ Added to waitlist! We\'ll notify you when a slot becomes available.');
                }
            }
        }

        function getCapacityStatus(capacity) {
            const percentage = (capacity.used / capacity.total) * 100;
            if (percentage >= 100) return 'Full';
            if (percentage >= 90) return 'Limited availability';
            if (percentage >= 70) return 'Filling up';
            return 'Available';
        }

        function updateSelectedLocationsList() {
            const container = document.getElementById('selectedLocationsList');
            const selectedLocations = Object.entries(locationData).filter(([id, data]) => data.selected);
            
            container.innerHTML = selectedLocations.map(([id, data]) => `
                <div class="selected-location-item">
                    <h4>${data.name}</h4>
                    <p>${data.description}</p>
                    <p><strong>$${data.cost}/month</strong> • Capacity: ${data.capacity.used}/${data.capacity.total}</p>
                </div>
            `).join('');
        }

        // Initialize map view on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show list view by default
            showListView();
        });

        // Subscriber functions
        function viewAnalytics() {
            alert('📊 Analytics Dashboard\n\nYour ads this month:\n• Total views: 12,400\n• Click-through rate: 2.8%\n• Top performing location: Downtown Mall\n• Best performing ad: Summer Sale Banner');
        }

        function viewAdAnalytics(adId) {
            const adData = {
                'summer-sale': {
                    name: 'Summer Sale Banner',
                    views: 3247,
                    ctr: '3.2%',
                    topLocation: 'Downtown Mall'
                },
                'product-launch': {
                    name: 'Product Launch Video',
                    views: 1892,
                    ctr: '2.1%',
                    topLocation: 'Coffee Shop Chain'
                }
            };
            
            const ad = adData[adId];
            if (ad) {
                alert(`📊 ${ad.name} Analytics\n\n• Total views: ${ad.views}\n• Click-through rate: ${ad.ctr}\n• Top location: ${ad.topLocation}\n• Status: Active on 8 screens`);
            }
        }

        function pauseAd(adId) {
            if (confirm('Are you sure you want to pause this ad? It will stop displaying on all screens.')) {
                alert('✅ Ad paused successfully. It will stop displaying within 15 minutes.');
            }
        }

        function toggleLocation(locationId) {
            const location = locationData[locationId];
            if (!location) return;
            
            const wasSelected = location.selected;
            const canSelect = !wasSelected && location.capacity.used < location.capacity.total;
            
            if (!wasSelected && !canSelect) {
                alert('✅ Added to waitlist! We\'ll notify you when a slot becomes available.');
                return;
            }
            
            const action = wasSelected ? 'remove' : 'add';
            const message = wasSelected 
                ? `Remove ${location.name} from your selected locations?\n\nThis will save $${location.cost}/month.`
                : `Add ${location.name} to your selected locations?\n\nThis will cost $${location.cost}/month.`;
            
            if (confirm(message)) {
                // Toggle selection
                location.selected = !location.selected;
                
                // Update selected locations list if map view is active
                if (document.getElementById('mapView').style.display !== 'none') {
                    updateSelectedLocationsList();
                    updateTotalCost();
                }
                
                alert(`✅ Location ${action === 'add' ? 'added' : 'removed'} successfully. Changes will take effect on your next billing cycle.`);
            }
        }

        function updateTotalCost() {
            const selectedLocations = Object.values(locationData).filter(loc => loc.selected);
            const totalCost = selectedLocations.reduce((sum, loc) => sum + loc.cost, 0);
            const totalScreens = selectedLocations.length;
            
            // Update the summary in map view
            const summaryElements = document.querySelectorAll('#mapView .campaign-card p');
            if (summaryElements.length > 0) {
                summaryElements[0].innerHTML = `Total: ${totalScreens} screens • Monthly cost: $${totalCost}`;
            }
        }

        function saveLocationSelection() {
            alert('✅ Location selection saved! Changes will be reflected in your next billing cycle.');
        }

        function upgradeToPremium() {
            window.location.href = 'payment.html?plan=premium&upgrade=true';
        }

        function processUpgrade() {
            alert('🚀 Redirecting to secure payment processing...');
            setTimeout(() => {
                window.location.href = 'payment.html?plan=premium&upgrade=true';
            }, 1000);
        }

        function updatePayment() {
            alert('💳 Redirecting to secure payment update...');
            setTimeout(() => {
                window.location.href = 'payment.html?action=update';
            }, 1000);
        }

        // Admin functions (only visible to admins)
        function refreshScreenData() {
            if (userRole === 'Administrator') {
                alert('🔄 Syncing with OptiSigns...\n\nFound 3 new screens\nUpdated 2 screen statuses\nSync completed successfully');
            }
        }

        function approveAd(adId) {
            if (userRole === 'Administrator') {
                if (confirm('Approve this ad for display?')) {
                    alert('✅ Ad approved and will be live within 15 minutes.');
                }
            }
        }

        function rejectAd(adId) {
            if (userRole === 'Administrator') {
                const reason = prompt('Reason for rejection (will be sent to subscriber):');
                if (reason) {
                    alert('❌ Ad rejected. Subscriber has been notified.');
                }
            }
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function uploadNewAd() {
            const title = document.getElementById('adTitle').value;
            const file = document.getElementById('adFile').files[0];
            const description = document.getElementById('adDescription').value;
            
            if (!title || !file) {
                alert('Please provide both a title and file for your ad.');
                return;
            }
            
            // Simulate upload process
            alert('📤 Uploading your ad...');
            
            setTimeout(() => {
                alert(`✅ "${title}" uploaded successfully!\n\nYour ad is now under review and will be live within 24-48 hours. You'll receive an email notification once it's approved.`);
                hideModal('uploadModal');
                document.getElementById('uploadForm').reset();
            }, 2000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }



        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</body>
</html>